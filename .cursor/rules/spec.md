# このファイルは Cursor への指示用です。【このファイルの内容を修正禁止】

# 推し活グッズ管理アプリ

主に BOX やガチャを管理する推し活支援アプリ。
バーコードの読み取りや製品写真を撮る事で、照合して可能な限り自動で製品を判別してタグ付けしてくれる。
使用者が収納場所をタグ付けする事で、リアルとデータをつないで、一覧で管理が加速する。

# 使用技術

- Python の Dash
- 将来的にフレームワークを変更する事も視野に入れて、ロジックを関数化する
- 公開は、GitHub にあげて、Render
- データベースは、SUPABASE
- アイコンは、Bootstrap Icons
  - [https://icons.getbootstrap.com/#accessibility](https://icons.getbootstrap.com/#accessibility)
- UI：
  - [https://www.dash-bootstrap-components.com/docs/](https://www.dash-bootstrap-components.com/docs/)
  - [https://bootswatch.com/](https://bootswatch.com/)

# 機能要件

- 【絶対必要】
  - スマホ画面対応
  - 推し色に合わせたカラー対応（背景とかアイコンとか）
    - Dash のテーマを使用して、設定画面から変更可能
  - グッズ情報との照合
  - バーコード読み取り
  - 画像マッチ
  - プライバシーポリシー
    - 機械学習でタグ付けするがアップロードされた写真は学習させません告知
  - 検索
  - SNS シェア
    - グッズ GET 投稿
    - 求＆譲の交換希望投稿
- 【第 2 フェーズ】
  - ダッシュボード
  - 家計簿的に推しに使用した金額
  - 推し色割合等のタグ分析
  - 推し初めて何日
  - ダブり&交換 OK 数管理
  - 収納場所管理
    - 番号割当で収納場所自由入力
    - 規定サイズタグを使用して、収納枚数計算（例：缶バッチ 24x24 が収納するのに仕分けクリアファイルが何枚必要か？全数は？）
- 【第 3 フェーズ】
  - 背景画像に合わせて、管理用に撮影したグッズ画像を貼り付けて、推し空間作成

# サイトマップ

- HOME
  - 写真を登録
  - 一覧
  - ダッシュボード
  - 推し部屋
  - 設定
    - アカウント情報
    - 収納場所タグ編集
    - 優先・任意タグ設定
    - テーマーカラー変更
    - プレミアムへ移行
    - お問い合わせ
    - バージョン情報
    - プライバシーポリシー
    - 利用規約
    - データを全て削除
    - 退会

# 開発予定の内容

## 製品登録のフロー（利用者画面では 1⇒2⇒6(タグ付けローディング中表示含む) の画面で進んでいきます）

製品は、グッズから漫画、書籍まで、何が登録されるか分かりません。 1.バーコードの読み取り or アップロード or バーコード番号の入力

- 手順 1
  - barcode_service.py と photo_service.py に該当
  - 1 ページ内の表示の順番は上から、読み取り ⇒ アップロード ⇒ バーコード番号の入力の順
  - 写真の読み取り時は、撮影中のライブビューイングがあるようにしてください
  - スキップする選択肢もボタンで用意する事
  - 読み取り or アップロード or バーコード番号の入力後、手順 2 に移行できるように自動遷移や入力確定ボタンを用意してください。
  - 情報を全て手動入力する選択肢ボタンも作成してください。
  - Output：バーコード情報を楽天 API に渡す（撮影した写真は、登録しない）
  - IF(失敗)：バーコード読み取りに失敗した場合は、「もう一度挑戦する」or「スキップ」の 2 択を選べるようにしてください。
  - IF（成功)：手順 2 に自動で移行してください。
- 手順 2.正面写真の登録（アップロード or 撮影）
  - ファイルは、関数化してください（写真の登録は、一覧に追加してからも関連写真として、追加できるようにするため、何度も使用機会があります）
  - スキップする選択肢もボタンで用意する事
  - 写真の読み取り時は、撮影中のライブビューイングがあるようにしてください。
  - この写真は、保存して、後で登録グッズの一覧画像で使用します。また、後でその写真を飾り付けたりにも使用します。
  - 最初のこの製品登録の際は、「正面写真」のみに限定します。可能な限り、アップで正面写真を撮ってもらうようにしてください。
  - 読み取り or アップロード後、手順 6 の画面に移行できるように、入力確定ボタンを用意してください。
  - 「もう一度挑戦する」or「スキップ」のボタンも選べるようにしてください。
- 手順 3.上記 1 のバーコード情報を楽天 API で照合して、製品情報を抽出
  - barcode_lookup.py に該当
  - Input：上記 1 のバーコード情報
  - Output：製品情報（登録情報・タグ付けに使用）
  - IF(失敗)：失敗した場合は、利用者に知らせる通知は不要。そのまま 4 の手順に進むだけ。
  - IF（成功）:成功しても 4 の手順に進みます。
- 手順 4.上記の 2 の写真を IO Intelligence API で画像内容を説明 ⇒IF.上記 3 が失敗した場合、テキストベースで楽天 API で照合
  - image_description.py に該当
  - IO Intelligence API(Vision モデル：例 LLaVA 系)は、絶対に使用してください。
  - 参考（精度が上がるならば検討してください）：CLIP（画像 ⇒ テキスト特徴抽出：ベクトル化）、FAISS(類似検索)
  - Input：上記 2 の写真
  - Output：製品情報（登録情報・タグ付けに使用）
  - IF(失敗)：上記 3 失敗時の照合は、写真からテキスト化した情報を楽天 API 検索等からお願いします。
  - IF(成功)：上記 3 が成功していた場合は、写真のテキスト化のみです。
  - 精度向上の参考：解像度の統一・トリミング（主題を中央に配置）・ノイズ除去＆露出補正
  - Output：製品情報（登録情報・タグ付けに使用）
- 手順 5.上記 3 の製品情報と上記 4 の製品テキスト情報からタグ抽出
  - tag_extraction.py に該当
  - 参考：IO Intelligence API(LLM)、spaCy や KeyBERT(タグ抽出)
  - 上記 3 と 4 の製品情報から、登録するためのタグを抽出
  - 上記 1 と 2 の両方をスキップした場合は、製品情報が無いため、手順 6 の画面に移動して、全てを利用者が入力できるようにしてください。
- 手順 6.ユーザーによる微調整

  - 上記手順 3 ～ 5 の間、Output の製品情報抽出が終わるまで、ローディング画面を表示してください。
  - 上記手順 5 が修了していなくても、利用者が登録ボタンを押せば登録できるようにしてください。
  - 照合した結果を表示して、利用者が微調整できるようにしてください。
  - 登録ボタンを表示して、登録を実行してください。
  - 登録完了後は、利用者に登録完了を通知する画面表示の後、最初の手順 1 の画面に戻ってください。

    ※注意事項：楽天 API で参照できる製品情報が理解できていないため、探索用の EDA.py を作成して、照合結果を全部表示してください。
    結果次第で、データベースの内容や登録する情報も変わります。

※参考 IO Intelligence API の使用方法
【モデル取得】

```
curl https://api.intelligence.io.solutions/api/v1/models
```

【API 実行】

```
curl https://api.intelligence.io.solutions/api/v1/chat/completions \
  -H 'Content-Type: application/json' \
  -H "Authorization: Bearer $IO_INTELLIGENCE_API_KEY" \
  -d '{
    "model": "meta-llama/Llama-3.2-90B-Vision-Instruct",
    "messages": [{"role":"user","content":"Say this is a test"}],
    "temperature": 0.7
  }'
```
